# =============================================================
# GitHub Actions CI/CD Pipeline
# =============================================================
# OBJETIVO: Automatizar testes, linting, coverage e deploy
#
# TRIGGERS:
# - Push em main/develop
# - Pull requests em main
#
# JOBS:
# 1. Lint: VerificaÃ§Ã£o de cÃ³digo (ruff/flake8)
# 2. Test: Testes automatizados com coverage
# 3. Security: Scan de dependÃªncias
# =============================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  PYTHON_VERSION: "3.11"
  DATABASE_HOST: localhost
  DATABASE_PORT: 3306
  DATABASE_USER: root
  DATABASE_PASSWORD: root
  DATABASE_NAME: test_db
  API_DEBUG: "false"
  ENVIRONMENT: "testing"

jobs:
  # =============================================================
  # JOB: Lint - VerificaÃ§Ã£o de CÃ³digo
  # =============================================================
  lint:
    name: ðŸ” Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
      
      - name: ðŸ“¥ Instalar dependÃªncias de lint
        run: |
          python -m pip install --upgrade pip
          pip install ruff flake8
      
      - name: ðŸ” Executar Ruff (linter rÃ¡pido)
        run: |
          ruff check src/ tests/ --output-format=github || true
        continue-on-error: true
      
      - name: ðŸ” Executar Flake8
        run: |
          flake8 src/ tests/ --max-line-length=120 --ignore=E501,W503 --count --statistics || true
        continue-on-error: true

  # =============================================================
  # JOB: Test - Testes Automatizados
  # =============================================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: ðŸ“¥ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: â³ Aguardar MySQL
        run: |
          until mysqladmin ping -h127.0.0.1 -uroot -proot --silent; do
            echo "Aguardando MySQL..."
            sleep 2
          done
      
      - name: ðŸ—ƒï¸ Preparar banco de teste
        run: |
          mysql -h127.0.0.1 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS test_db;"
        env:
          MYSQL_PWD: root
      
      - name: ðŸ§ª Executar testes com coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=45 \
            -v \
            --tb=short
        env:
          DATABASE_HOST: 127.0.0.1
          DATABASE_PORT: 3306
          DATABASE_USER: root
          DATABASE_PASSWORD: root
          DATABASE_NAME: test_db
      
      - name: ðŸ“Š Upload coverage para Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true
      
      - name: ðŸ“ Upload relatÃ³rio de coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  # =============================================================
  # JOB: Security - Scan de Vulnerabilidades
  # =============================================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¥ Instalar ferramentas de seguranÃ§a
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit pip-audit
      
      - name: ðŸ”’ Scan de dependÃªncias (pip-audit)
        run: |
          pip-audit -r requirements.txt --strict || true
        continue-on-error: true
      
      - name: ðŸ”’ Scan de cÃ³digo (Bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll --skip B101
        continue-on-error: true
      
      - name: ðŸ“ Upload relatÃ³rio de seguranÃ§a
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 7
        if: always()

  # =============================================================
  # JOB: Build - Verificar se aplicaÃ§Ã£o inicia
  # =============================================================
  build:
    name: ðŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¥ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ—ï¸ Verificar imports
        run: |
          python -c "from src.main import app; print('âœ… AplicaÃ§Ã£o importada com sucesso')"
      
      - name: ðŸ—ï¸ Verificar configuraÃ§Ã£o
        run: |
          python -c "from src.config import settings; print(f'âœ… ConfiguraÃ§Ã£o OK: {settings.API_TITLE}')"

  # =============================================================
  # JOB: Summary - Resumo do Pipeline
  # =============================================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()
    
    steps:
      - name: ðŸ“‹ Gerar resumo
        run: |
          echo "## ðŸ“‹ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
